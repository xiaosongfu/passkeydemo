<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Passkey Demo</title>
  </head>
  <body>
    <button onclick="create()">Create</button>
    <br />
    <button onclick="read()">Read</button>
  </body>
  <script async>
    const userId = "123";
    async function create() {
      console.log("create");

      const publicKeyCredentialCreationOptions = {
        challenge: str2ab("asfs"),
        rp: {
          name: "Localhost",
          id: "xiaosongfu.github.io",
        },
        user: {
          id: str2ab(userId),
          name: "Tom",
          displayName: "Tom",
        },
        pubKeyCredParams: [
          { alg: -7, type: "public-key" },
          { alg: -257, type: "public-key" },
        ],
        authenticatorSelection: {
          authenticatorAttachment: "platform",
          requireResidentKey: true,
        },
      };

      const credential = await navigator.credentials.create({
        publicKey: publicKeyCredentialCreationOptions,
      });
      console.log("create-credential~~ ", credential);
    }

    async function read() {
      console.log("read");

      const abortController = new AbortController();

      const publicKeyCredentialRequestOptions = {
        // Server generated challenge
        challenge: str2ab("gdsdf"),
        // The same RP ID as used during registration
        rpId: "xiaosongfu.github.io",
      };

      const credential = await navigator.credentials.get({
        publicKey: publicKeyCredentialRequestOptions,
        signal: abortController.signal,
        // Specify 'conditional' to activate conditional UI
        mediation: "conditional",
      });

      console.log("get-credential~~ ", credential);
    }

    function str2ab(str) {
      var buf = new ArrayBuffer(str.length * 2); // 2 bytes for each char
      var bufView = new Uint16Array(buf);
      for (var i = 0, strLen = str.length; i < strLen; i++) {
        bufView[i] = str.charCodeAt(i);
      }
      return buf;
    }
  </script>
</html>
